 ![Arch: x86/ARM](https://img.shields.io/badge/arch-x86%2FARM-blue) ![contributions welcome](https://img.shields.io/badge/contributions-welcome-red) ![License: MIT](https://img.shields.io/badge/license-MIT-green)

# Description

Portable executable files (PEX) are executables that can be moved between different ISA's and cpu feature sets. PEX files are built around the LLVM intermediate representation (IR). The PEX-Suite contains the following programs:

- `pexcc` acts as a wrapper around the clang compiler and can be used to generate enriched object files that contain the IR of the corresponding .c file. 
- `pexld` is used to link multiple .o files generated by `pexcc` into one PEX.
- `pexmngr` is a convenience program that allows to inspect and manipulate existing PEX files.

The PEX-Suite is only tested/developed for the C programming language. However, most of the code should be easy to port to other languages that are supported by LLVM.  

# Installation

1. Clone the repository.
2. Execute the install script: `sudo ./install.sh`.
3. Make sure that `/usr/bin` is in your PATH.
4. Profit.

# Basic Usage

## Executing a PEX file

Execute it just like any other executable (`./example.pex arg1 arg2`). The new part - move it between your favorite ARM and x86 machines and the program still works (hopefully)!

**Environment Variables**

If you want to run the specific tag `NAME` from a PEX file use the environment variable `PEX_USE_TAG`: `PEX_USE_TAG=NAME ./example.pex arg1 arg2`.

For verbose logging from the PEX internals, set the environment variable `PEX_VERBOSE` like `PEX_VERBOSE=1 ../example.pex arg1 arg2`.

## Building a PEX file
`pexcc` and `pexld` wrap around the `clang` compiler and linker. They can be used as drop-in replacements in your `Makefile`. Flags are passed to `clang`.

**Example Makefile**

```Makefile
CC = pexcc
LD = pexld

all: example.pex

example.pex: example.o
	$(LD) $(LDFLAGS) -o $@ $^

example.o: example.c
	$(CC) $(CFLAGS) -c -o $@ $<
```
A small example project with a corresponding Makefile can be found in the repository.

**Environment Variables**

- For logging from `pexcc` and `pexld` set the environment variable `PEX_VERBOSE` like `PEX_VERBOSE=1 make`.
- If you want to tag the .o file in the PEX as `NAME` you can do so using another environment variable like `PEX_STORE_AS=NAME make`.

## Managing PEX files

Call the pexmanager: `pexmngr PEX OPERATION`.
The following `OPERATIONS` are supported:

- `--help` shows a help message. 
- `--ls` lists the contents of the PEX file.
- `--tree` like ls, but depends on `tree` for the output for prettier formatting.
- `--extract [NAME]` extracts the contents of the PEX file into a folder `NAME`. `NAME` defaults to `tar`.
- `--rm [TAG]` removes a set of .o files stored under `TAG` from the PEX file. `TAG` defaults to the current architecture triple.
- `--merge PEX_2` merges the contents of `PEX_2` into `PEX`. *Careful: This assumes that the tags inside the two files are disjoint!* 

# Dependencies

- bash
- clang
- optional: tree

# Known Issues


- Mismatching clang versions on origin and target can cause issues. For example clang version 3.8 cannot handle the ll files that are created by clang 6.0. The reason is that clang 6.0 adds a line with the `source_filename` to the ll file.
- Also `-g` (Compilerflag) does not work between at least those specific clang versions.
- State of at least shared libraries is not clear. We would be surprised if this worked. If you experiment with shared libraries or dynamic linking, we are eager to hear your results!

# License

MIT.

---

# Please leave alone :)
## Working Documents

- https://docs.google.com/presentation/d/1biVTXz3gK39o9Dwn-jxoF9ux6jUNhgwwYWMy0ohwx8Q/edit?usp=sharing
- https://hackmd.io/bBzsgc8UQgaThXf8I4qtPw?both
- https://www.mathcha.io/editor/xqGoS6lfvrhP8zGO7cY9wg6zs20zne2U1Qzg7x (read only)
